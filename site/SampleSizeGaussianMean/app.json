[{"name":"app.R","content":"webr::install('ggplot2')\r\nwebr::install('htmlTable')\r\nwebr::install('grid')\r\nlibrary(shiny)\r\nlibrary(ggplot2)\r\nlibrary(grid)\r\nlibrary(htmlTable)\r\n\r\n#####\r\n##### AUXILIARY FUNCTIONS #### \r\n#####\r\nlengthIC <- function(n, sigma.hat, alpha = 5 / 100) {\r\n  2 * qt(1 - alpha / 2, n - 1) * sigma.hat / sqrt(n)\r\n}\r\n# credibility interval for standard deviation\r\nICsigma <- function(n, sigma.hat, alpha = 5 / 100) {\r\n  bmin <- sqrt(qchisq(alpha / 2, n - 1))\r\n  bmax <- sqrt(qchisq(1 - alpha / 2, n - 1))\r\n  sqrt.scr <- sigma.hat * sqrt(n - 1)\r\n  c(lwr = sqrt.scr / bmax, upr = sqrt.scr / bmin)\r\n}\r\n# square root of inverse gamma distribution\r\ndigamma <- function(y, a, b) {\r\n  dgamma(1 / y, a, b) / y^2\r\n}\r\ndsqrtigamma <- function(y, a, b) {\r\n  digamma(y^2, a, b) * 2 * y\r\n}\r\nqsqrtigamma <- function(p, a, b) {\r\n  sqrt(1 / qgamma(1 - p, a, b))\r\n}\r\n\r\n\r\n# Shiny UI ####\r\nui <- pageWithSidebar(\r\n  \r\n  # Application title\r\n  headerPanel(\"Sample size determination for estimating a mean\"),\r\n  \r\n  # Sidebar with a slider input for number of observations\r\n  sidebarPanel(\r\n    h3(\"Standard deviation uncertainty:\"),\r\n    helpText(\r\n      \"Note: the distribution plotted at right show the uncertainty \r\nabout the standard deviation resulting from your preliminary data. \r\n      It depends on the sample size and the standard deviation estimate of your preliminary sample.\"),\r\n    # \r\n    h4(\"Set the size of the sample you used to estimate the standard deviation:\"),\r\n    numericInput(\"n\", \r\n                 \"\",\r\n                 min=2,\r\n                 max=200,\r\n                 value=5,\r\n                 step=1),\r\n    \r\n    h4(\"Set estimated standard deviation:\"),\r\n    numericInput(\"sigma.hat\", \r\n                 \"\", \r\n                 min = 0.5, \r\n                 max = 50, \r\n                 value = 5, \r\n                 step = 0.5),\r\n    helpText(\"Set here the standard deviation estimated from your preliminary experiments\"), \r\n    br(), \r\n    h3(\"Half-width of the confidence interval about the mean:\"), \r\n    h4(\"Set confidence level (%):\"),\r\n    sliderInput(\"level\", \"\",  min = 50, max = 99, value=95, \r\n                step = 1),\r\n    helpText(\"Set here the confidence level of the confidence interval you want to predict\"),\r\n    #\th4(\"Confidence interval about the mean:\"), \r\n    # \r\n    h4(\"Set prediction error  (%):\"), \r\n    sliderInput(\"credibility\", \"\",  min = 1, max = 50, value=40, \r\n                step = 0.5),  \r\n    helpText(\r\n      \"Set here the error probability of the predicted half-width\"),\r\n    br(), \r\n    numericInput(\"nmin\", \r\n                 \"Minimum sample size\", \r\n                 min = 2, \r\n                 max = 15, \r\n                 value = 5,\r\n                 step = 1),\r\n    numericInput(\"nmax\", \r\n                 \"Maximum sample size\", \r\n                 min = 16, \r\n                 max = 200, \r\n                 value = 30,\r\n                 step = 1)\r\n  ),\r\n  mainPanel(\r\n    #h2(\"Standard deviation uncertainty\"),\r\n    h4(\"Warning: the uncertainty about the standard deviation estimate plays a serious role in the determination of the sample size\"),\r\n    div(class=\"container\",\r\n        #div(class=\"span6\",\r\n        #\th5(\"Confidence interval about the standard deviation: \")\r\n        #),\r\n        #div(class=\"span3\", \r\n        plotOutput(\"PlotSigmaIC\")\r\n        #),\r\n        #div(class=\"span3\", \r\n        #\t\"\"\r\n        #)\r\n    ),\r\n    br(),\r\n    h2(\"Half-width of the confidence interval about the mean\"),\r\n    helpText(\"The blue line shows the predicted half-width: this is the \r\nhalf-width you would get if the \r\nestimated standard deviation of your future data is exactly\", \r\n             span(id=\"sigma\", class=\"shiny-text-output\")), \r\n    helpText(\"The shaded area shows the uncertainty about the blue line \r\nresulting from the uncertainty about your standard deviation estimate\", \r\n             \"More precisely, the half-width has\", \r\n             span(id=\"credibilitybis\", class=\"shiny-text-output\"), \r\n             \"% probability to lie outside the shaded area\", \r\n             \"(\", \r\n             span(id=\"halfcredibility\", class=\"shiny-text-output\"), \r\n             \"% below the lower line as well as beyond the upper line).\", \r\n             \"You can set this error preditcion level at the bottom in the sidebar.\"), \r\n    plotOutput(\"PlotLengthIC\"),\r\n    br(),\r\n    htmlOutput(\"htmltab\")\r\n  )\r\n)\r\n\r\n# Shiny server ####\r\nserver <- function(input, output, session) {\r\n  #\r\n  output$n <- reactive({input$n})\r\n  output$credibility <- reactive({100-input$credibility})\r\n  output$credibilitybis <- reactive({input$credibility})\r\n  output$halfcredibility <- reactive({input$credibility/2})\r\n  output$sigma <- reactive({input$sigma.hat})\r\n  #\r\n  DF1 <- reactive({\r\n    level <- input$level\r\n    alpha <- (100-level)/200\r\n    sigma <- input$sigma.hat\r\n    nmin <- input$nmin\r\n    nmax <- input$nmax\r\n    ll <- sapply(nmin:nmax, function(n) lengthIC(n,sigma.hat=sigma,alpha=alpha))/2\r\n    df1 <- data.frame(n=nmin:nmax, hwidth=ll)\r\n    list(df1=df1, level=level, sigma=sigma)    \r\n  })\r\n  PlotLengthIC0 <- reactive({\r\n    # \r\n    loadDF1 <- DF1()\r\n    df1 <- loadDF1$df1\r\n    level <- loadDF1$level\r\n    cred <- 100-input$credibility\r\n    #sigma <- loadDF1$sigma\r\n    titl <- bquote(paste(\"Predicted half-width of the \", \r\n                         .(level),  \"%-confidence interval about the mean \", \r\n                         \"and \", .(cred), \"%-prediction band\"))\r\n    p <- ggplot(df1, aes(x=n,y=hwidth)) + geom_line(colour=\"blue\") + \r\n      geom_point(colour=\"orange\") + ggtitle(titl) +\r\n      xlab(\"sample size\") + ylab(\"half-width\") \r\n    list(p=p,nn=df1$n)\r\n  })\r\n  #\r\n  DFband <- reactive({\r\n    loadDF1 <- DF1()\r\n    df1 <- loadDF1$df1\r\n    alpha <- (100-loadDF1$level)/200\r\n    sigma <- loadDF1$sigma\r\n    nn <- df1$n\r\n    cred <- 100-input$credibility\r\n    n <- input$n\r\n    band <- data.frame(n=nn,lcl=NA,ucl=NA)\r\n    lcl.sig <- sigma*sqrt(qf((100-cred)/200, nn-1, n-1)) \r\n    band$lcl <-  sapply(1:nrow(band), function(i){ \r\n      lengthIC(nn[i], lcl.sig[i], alpha=alpha)/2\r\n    })\r\n    ucl.sig <- sigma*sqrt(qf((100+cred)/200,nn-1,n-1)) \r\n    band$ucl <-  sapply(1:nrow(band), function(i){ \r\n      lengthIC(nn[i], ucl.sig[i], alpha=alpha)/2\r\n    })\r\n    list(df1=df1,band=band)\r\n  })\r\n  output$PlotLengthIC <- renderPlot({\r\n    P0 <- PlotLengthIC0()\r\n    p <- P0$p\r\n    loadband <- DFband()\r\n    band <- loadband$band\r\n    p <- p + geom_ribbon(data=band,aes(x=n,y=NULL,ymin=lcl,ymax=ucl), color=\"white\", linetype=0, alpha=0.3) \r\n    print(p)\r\n  })\r\n  #\r\n  # TABLE PREDICTIONS\r\n  #\r\n  output$htmltab <- reactive({\r\n    loadband <- DFband()\r\n    df1 <- loadband$df1\r\n    band <- loadband$band\r\n    df.predict <- cbind(df1,band[,-1])\r\n    rnd <- max(1-floor(log10(min(df1$hw))),0)\r\n    df.predict <- sapply(df.predict, function(x) round(x,rnd))\r\n    #rownames(df.predict) <- df1$n \r\n    colnames(df.predict) <-c(\"Sample size\", \"half-width\", \"lower bound\", \"upper bound\")\r\n    cred <- 100-input$credibility \r\n    htmlTable(df.predict, \r\n              title=\"\", #rowlabel=\"aa\", rowname=\"iii\", \r\n              #n.rgroup=c(nrow(df1)), rgroup=c(\"Sample size\"),\r\n              n.cgroup=c(1,1,2), \r\n              cgroup=c(\"\",\"predicted value\", paste0(cred, \"%-prediction interval\")), \r\n              #cgroup.just = c(\"l\",\"r\"), \r\n              ctable=TRUE, output=FALSE,\r\n              caption=\"Predicted half-width in function of sample size\")\r\n  })\r\n  #\r\n  plotSigmaIC <- reactive({\r\n    n <- input$n\r\n    sigma <- input$sigma.hat\r\n    bounds0 <- qsqrtigamma(c(.0000000001,.99),(n-1)/2,(n-1)*sigma^2/2) #ICsigma(n,sigma.hat,.01)\r\n    # QUARTILES : \r\n    Quar <-  qsqrtigamma(c(25,50,75)/100,(n-1)/2,(n-1)*sigma^2/2)     \r\n    Qdf <- data.frame(\r\n      Quartiles=paste0(c(25,50,75),\"%\"), \r\n      x=Quar, \r\n      xend=Quar, \r\n      y=0, \r\n      yend=dsqrtigamma(Quar,(n-1)/2,(n-1)*sigma^2/2))\r\n    list(n=n,sigma.hat=sigma,bounds0=bounds0,Qdf=Qdf)\r\n  })\r\n  #\r\n  output$PlotSigmaIC <- renderPlot({\r\n    params <- plotSigmaIC()\r\n    bounds0 <- params$bounds0\r\n    sigma.hat <- params$sigma.hat\r\n    Qdf <- params$Qdf\r\n    n <- params$n\r\n    x <- seq(bounds0[1],bounds0[2],length=100)\r\n    df <- data.frame(x,y=dsqrtigamma(x, (n-1)/2, (n-1)*sigma.hat^2/2))  \t\r\n    p <- ggplot(data=df, aes(x=x, y=y)) + \r\n      geom_line(colour=\"blue\", linewidth=1.4) + \r\n      geom_segment(data=Qdf, aes(x=x,xend=xend,y=y,yend=yend,colour=Quartiles),linetype=\"twodash\") +\r\n      xlab(\"standard deviation\") + ylab(NULL) + \r\n      ggtitle(\"Standard deviation uncertainty\") +\r\n      theme(axis.text.y=element_blank(), \r\n            axis.ticks.y=element_blank(),\r\n            axis.text.x=element_text(face=\"bold\",size=14),\r\n            #axis.ticks.margin=unit(0, \"mm\"), \r\n            panel.background=element_rect(fill=\"grey95\"),\r\n            #panel.grid=element_blank(),\r\n            plot.title=element_text(face=\"italic\",size=23)\r\n            #panel.border = element_rect(fill = \"grey90\", colour = NA)\r\n      ) +\r\n      scale_y_continuous(expand=c(0,0))\r\n    print(p)\r\n  }, width=525)\r\n}\r\n\r\n# Create Shiny app ----\r\nshinyApp(ui = ui, server = server)\r\n","type":"text"}]
